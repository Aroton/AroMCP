name: "analyze:dependencies"
description: "Analyze npm dependencies"

default_state:
  raw:
    package_json: ""
    npm_list: ""

state_schema:
  raw:
    package_json: string
    npm_list: string

  computed:
    dependencies:
      from: "raw.package_json"
      transform: |
        JSON.parse(input).dependencies || {}

    outdated_deps:
      from: "raw.npm_list"
      transform: |
        input.split('\n')
          .filter(line => line.includes('outdated'))
          .map(line => {
            const parts = line.split(/\s+/);
            return {
              name: parts[0],
              current: parts[1],
              wanted: parts[2],
              latest: parts[3]
            };
          })

    security_risks:
      from: ["computed.outdated_deps", "computed.dependencies"]
      transform: |
        input[0].filter(dep => {
          const current = input[1][dep.name];
          return current && dep.latest.split('.')[0] > current.split('.')[0];
        })

steps:
  - id: "read_package"
    type: "shell_command"
    command: "cat package.json"
    output_format: "text"
    state_update:
      path: "raw.package_json"

  - id: "check_outdated"
    type: "shell_command"
    command: "npm outdated --json || true"
    output_format: "text"
    state_update:
      path: "raw.npm_list"

  - id: "report"
    type: "user_message"
    message: |
      Found {{ outdated_deps.length }} outdated dependencies
      Major version updates needed: {{ security_risks.length }}